{% extends "base.html" %}

{% block title %}Manage Wishes - Mangalify Dashboard{% endblock %}

{% block content %}
<div class="card">
    <h2>Custom Wishes ({{ wishes|length }})</h2>
    
    {% if wishes %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Message</th>
                <th>Role to Ping</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for wish in wishes %}
            <tr id="wish-{{ wish._id }}">
                <td><strong>{{ wish.name }}</strong></td>
                <td>{{ wish.day }}/{{ wish.month }}/{{ wish.year }}</td>
                <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    {{ wish.message }}
                </td>
                <td>
                    {% if wish.role_id == 'everyone' %}
                        @everyone
                    {% elif wish.role_id %}
                        Role ID: {{ wish.role_id }}
                    {% else %}
                        None
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-danger" onclick="deleteWish('{{ wish._id }}')">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No custom wishes created yet</p>
        <p style="font-size: 14px; margin-top: 10px;">Staff can create custom wishes using the /add_wish command in Discord</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function deleteWish(wishId) {
        if (!confirm('Are you sure you want to delete this wish?')) {
            return;
        }
        
        fetch(`/api/wishes/${wishId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                const row = document.getElementById(`wish-${wishId}`);
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        
                        // Check if table is now empty
                        const tbody = document.querySelector('tbody');
                        if (!tbody || tbody.children.length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
                alert('Wish deleted successfully');
            } else {
                alert('Failed to delete wish');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the wish');
        });
    }
</script>
{% endblock %}
